<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVMe Security Deep Dive - TCG Opal & Hardware Security</title>
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <link rel="stylesheet" href="../../assets/css/demo-enhancements.css">
    <style>
        .security-tier { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .threat-model { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
        .security-component { border-left: 4px solid #dc2626; background: #fef2f2; }
        .encryption-layer { background: #fefce8; border: 2px solid #eab308; }
        .security-demo { background: #f8fafc; border: 1px solid #e2e8f0; }
        .vulnerability-alert { background: #fee2e2; border-left: 3px solid #dc2626; }
        .mitigation-success { background: #f0fdf4; border-left: 3px solid #16a34a; }
    </style>
</head>

<body>
    <header class="demo-header">
        <nav>
            <a href="../../index.html">ğŸ  Course Home</a>
            <a href="../module-0-crypto/index.html">ğŸ“– Module 0</a>
            <a href="index.html">ğŸ”§ Module 1</a>
        </nav>
        <h1>ğŸ”’ NVMe Security Deep Dive</h1>
        <p>TCG Opal, Hardware Encryption & Threat Mitigation</p>
    </header>

    <main class="demo-container">
        <!-- TCG Opal Security Architecture -->
        <section class="demo-section">
            <h2 class="section-title security-tier">ğŸ›¡ï¸ TCG Opal Security Architecture</h2>

            <div class="security-component">
                <h3>ğŸ” Self-Encrypting Drive (SED) Foundation</h3>
                <div class="security-demo">
                    <h4>Hardware-Based Encryption Benefits</h4>
                    <ul>
                        <li><strong>Performance:</strong> Zero CPU overhead - encryption happens at line speed</li>
                        <li><strong>Transparency:</strong> No OS/application changes required</li>
                        <li><strong>Key Security:</strong> Encryption keys never leave the drive controller</li>
                        <li><strong>Instant Erase:</strong> Cryptographic erase in milliseconds vs. hours</li>
                        <li><strong>Power Loss Protection:</strong> Hardware-protected key storage</li>
                    </ul>

                    <h4>TCG Opal Protocol Stack</h4>
                    <pre class="code-block">
# TCG Opal Security Layers
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Application Layer                â”‚ â† Enterprise Key Management
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        TCG Opal Commands                â”‚ â† Authentication, Authorization
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Trusted Computing                â”‚ â† Security Functions
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Storage Interface                â”‚ â† NVMe/SATA/SAS Commands
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Drive Controller                 â”‚ â† Hardware Encryption Engine
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Key TCG Opal Security Features:
â€¢ Pre-boot Authentication (PBA)
â€¢ Range-based Encryption (multiple users/partitions)
â€¢ Secure Messaging Protocol
â€¢ Hardware-enforced Access Controls
â€¢ Cryptographic Erase
                    </pre>
                </div>

                <h3>ğŸ”‘ Opal Security Protocols</h3>
                <div class="encryption-layer">
                    <h4>Authentication Methods</h4>
                    <ul>
                        <li><strong>Password-based:</strong> PBKDF2 with user-defined credentials</li>
                        <li><strong>Certificate-based:</strong> X.509 certificates for enterprise environments</li>
                        <li><strong>Biometric:</strong> Fingerprint/face recognition integration</li>
                        <li><strong>Smart Card/Token:</strong> PKCS#11 token-based authentication</li>
                        <li><strong>Multi-factor:</strong> Combination of methods for enhanced security</li>
                    </ul>

                    <h4>Range-Based Encryption Configuration</h4>
                    <pre class="code-block">
# sedutil-cli commands for Opal configuration

# Initialize Opal security (WARNING: Destructive operation)
sedutil-cli --initialSetup &lt;password&gt; /dev/nvme0n1

# Create locking ranges for multi-user scenarios
sedutil-cli --setupLockingRange 0 1024 2000000 &lt;RWPassword&gt; /dev/nvme0n1

# Enable locking range
sedutil-cli --enableLockingRange 0 &lt;password&gt; /dev/nvme0n1

# Configure user authorities
sedutil-cli --setPassword &lt;oldpassword&gt; &lt;user&gt; &lt;newpassword&gt; /dev/nvme0n1

# Query Opal configuration
sedutil-cli --query /dev/nvme0n1

# Example Output:
/dev/nvme0n1 Samsung SSD 980 PRO 2TB
TPer function (0x0001):
    COMID Management Supported
    Streaming Supported
    Buffer Management Supported
    ACK/NAK Supported
    Asynchronous Supported
    COMID 0x0001
Locking function (0x0002):
    Locking Supported
    Locking Enabled
    MBR Enabled
    MBR Done
    Locking Range Count: 8
                    </pre>
                </div>
            </div>
        </section>

        <!-- Advanced Security Features -->
        <section class="demo-section">
            <h2 class="section-title">ğŸ”§ Advanced NVMe Security Features</h2>

            <div class="security-component">
                <h3>ğŸš€ NVMe Security Commands & Features</h3>

                <div class="security-demo">
                    <h4>Security Send/Receive Commands</h4>
                    <pre class="code-block">
# NVMe Security Commands Implementation
struct nvme_security_send_cmd {
    __u8    opcode;          // 0x81 for Security Send
    __u8    security_protocol;
    __u16   security_protocol_specific;
    __u32   transfer_length;
    __u8    *data_payload;
};

# Security Protocols:
â€¢ 0x00: Security Protocol Information
â€¢ 0x01: TCG (Trusted Computing Group)
â€¢ 0x02: CbCS (Certificate-based Client Security)
â€¢ 0x20-0x6F: Vendor Specific
â€¢ 0xEF: SAS SSP (Serial Attached SCSI)

# Example: TCG Discovery (Security Protocol 0x01)
nvme security-recv /dev/nvme0n1 --protocol=1 --spsp=1 --size=2048
                    </pre>

                    <h4>Sanitize Operations</h4>
                    <ul>
                        <li><strong>Block Erase:</strong> Overwrites all user data areas</li>
                        <li><strong>Crypto Erase:</strong> Changes encryption keys (TCG Opal)</li>
                        <li><strong>Overwrite:</strong> Multiple pass overwrite with patterns</li>
                        <li><strong>Exit Failure Mode:</strong> Recovery from failed sanitize operations</li>
                    </ul>

                    <h4>Sanitize Command Examples</h4>
                    <pre class="code-block">
# NVMe Sanitize Commands

# Check sanitize capabilities
nvme id-ctrl /dev/nvme0n1 | grep -i sanitize

# Crypto erase (fastest, requires TCG Opal)
nvme sanitize /dev/nvme0n1 --crypto-erase

# Block erase (medium speed, hardware-based)
nvme sanitize /dev/nvme0n1 --block-erase

# Overwrite with pattern (slowest, most thorough)
nvme sanitize /dev/nvme0n1 --overwrite --ovrpat=0xDEADBEEF

# Monitor sanitize progress
watch 'nvme sanitize-log /dev/nvme0n1'

# Example sanitize log output:
Sanitize Progress (SPROG)                   : 65535
Sanitize Status (SSTAT)                     : 0x2
    Sanitize Completed Successfully
    No Unrestricted Sanitize Operation Pending
Global Data Erased (GDE)                    : 1
No-Deallocate Inhibited (NDI)               : 0
                    </pre>
                </div>

                <h3>ğŸ” Enterprise Key Management Integration</h3>
                <div class="encryption-layer">
                    <h4>KMIP (Key Management Interoperability Protocol)</h4>
                    <pre class="code-block">
# Enterprise Key Management Architecture

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Enterprise Key Manager                 â”‚
â”‚    (HashiCorp Vault, AWS KMS, Azure Key Vault)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ KMIP Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              KMIP Client/Proxy                      â”‚
â”‚    (Storage Management Software, Ansible)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ TCG Opal Commands
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NVMe SED Array                         â”‚
â”‚    (Individual drives with hardware encryption)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Sample KMIP workflow for SED provisioning:
1. Generate DEK (Data Encryption Key) in KMS
2. Wrap DEK with KEK (Key Encryption Key)
3. Push wrapped DEK to SED via Opal commands
4. SED unwraps DEK and stores in secure hardware
5. All data encryption uses hardware-stored DEK
                    </pre>

                    <h4>Ansible Integration for SED Management</h4>
                    <pre class="code-block">
---
# Playbook: Enterprise SED Deployment
- name: Deploy Self-Encrypting Drives
  hosts: storage_nodes
  vars:
    kmip_server: "vault.company.com:5696"
    sed_devices:
      - /dev/nvme0n1
      - /dev/nvme1n1
      - /dev/nvme2n1

  tasks:
    - name: Discover SED capabilities
      shell: sedutil-cli --scan
      register: sed_scan

    - name: Initialize Opal security
      shell: |
        # Get encryption key from Vault
        KEY=$(vault kv get -field=key secret/sed/{{ inventory_hostname }}/{{ item }})

        # Initialize SED with enterprise key
        sedutil-cli --initialSetup {{ KEY }} {{ item }}
      loop: "{{ sed_devices }}"
      no_log: true  # Don't log sensitive key operations

    - name: Configure locking ranges
      shell: |
        sedutil-cli --setupLockingRange 0 0 {{ ansible_device_size }} {{ sed_password }} {{ item }}
        sedutil-cli --enableLockingRange 0 {{ sed_password }} {{ item }}
      loop: "{{ sed_devices }}"

    - name: Verify Opal configuration
      shell: sedutil-cli --query {{ item }}
      loop: "{{ sed_devices }}"
      register: opal_status

    - name: Report SED status
      debug:
        msg: "{{ item.stdout_lines }}"
      loop: "{{ opal_status.results }}"
                    </pre>
                </div>
            </div>
        </section>

        <!-- Threat Models & Attack Vectors -->
        <section class="demo-section">
            <h2 class="section-title threat-model">âš ï¸ NVMe Security Threat Models</h2>

            <div class="security-component">
                <h3>ğŸ¯ Attack Vectors & Threat Landscape</h3>

                <div class="vulnerability-alert">
                    <h4>âŒ Physical Security Threats</h4>
                    <ul>
                        <li><strong>Drive Theft:</strong> Physical removal of drives from datacenter</li>
                        <li><strong>Evil Maid:</strong> Unauthorized physical access to servers</li>
                        <li><strong>Cold Boot:</strong> Memory forensics on powered-down systems</li>
                        <li><strong>Hardware Implants:</strong> Supply chain interdiction attacks</li>
                        <li><strong>Side-Channel:</strong> Power analysis, electromagnetic emissions</li>
                    </ul>

                    <h4>ğŸ” Firmware & Implementation Attacks</h4>
                    <ul>
                        <li><strong>Firmware Vulnerabilities:</strong> Buffer overflows in SED controller</li>
                        <li><strong>Crypto Implementation Flaws:</strong> Weak RNG, poor key derivation</li>
                        <li><strong>Opal Protocol Bypasses:</strong> Authentication bypasses</li>
                        <li><strong>Vendor Backdoors:</strong> Hidden master passwords</li>
                        <li><strong>Update Attacks:</strong> Malicious firmware updates</li>
                    </ul>

                    <h4>ğŸ“Š Real-World Vulnerability Examples</h4>
                    <pre class="code-block">
# Historical SED Vulnerabilities (Educational Analysis)

CVE-2018-12037 (Crucial/Micron SEDs):
- Master password bypass in older firmware
- Impact: Complete data access without user password
- Mitigation: Firmware updates, migration to newer drives

CVE-2019-18900 (Samsung T7 Touch):
- Authentication bypass in USB SED
- Impact: Access without biometric/password authentication
- Mitigation: Firmware update, enhanced validation

TCG Opal Implementation Issues:
- Weak default passwords in some implementations
- Insufficient entropy in key generation
- Race conditions in authentication flows
- Missing firmware signature validation

# Vulnerability Assessment Commands
sedutil-cli --query /dev/nvme0n1 | grep -i firmware
nvme fw-log /dev/nvme0n1
nvme smart-log /dev/nvme0n1 | grep -i security
                    </pre>
                </div>

                <div class="mitigation-success">
                    <h4>âœ… Security Best Practices & Mitigations</h4>

                    <h5>ğŸ”’ Defense in Depth Strategy</h5>
                    <ul>
                        <li><strong>Hardware Root of Trust:</strong> TPM-based key derivation</li>
                        <li><strong>Secure Boot:</strong> Verify SED firmware integrity</li>
                        <li><strong>Network Encryption:</strong> TLS for management traffic</li>
                        <li><strong>Access Controls:</strong> Role-based SED management</li>
                        <li><strong>Monitoring:</strong> SED status and anomaly detection</li>
                    </ul>

                    <h5>ğŸ›¡ï¸ Implementation Guidelines</h5>
                    <pre class="code-block">
# Security Configuration Checklist

1. SED Selection & Validation:
   - FIPS 140-2 Level 2 certified drives
   - Recent firmware with security patches
   - Verified supply chain provenance

2. Key Management:
   - Enterprise KMS integration (Vault, AWS KMS)
   - Regular key rotation schedule (quarterly)
   - Hardware-backed key storage (HSM/TPM)
   - Secure key backup and recovery procedures

3. Access Controls:
   - Multi-factor authentication for SED management
   - Role-based access (Admin, Operator, Auditor)
   - Principle of least privilege
   - Regular access reviews and deprovisioning

4. Monitoring & Compliance:
   - SIEM integration for SED events
   - Regular vulnerability assessments
   - Compliance reporting (FIPS, Common Criteria)
   - Incident response procedures for SED compromise

# Example monitoring script
#!/bin/bash
# SED Security Monitoring

for DEVICE in /dev/nvme*n1; do
    # Check Opal status
    OPAL_STATUS=$(sedutil-cli --query $DEVICE 2>/dev/null | grep "Locking Enabled")

    # Check for security events
    SMART_LOG=$(nvme smart-log $DEVICE | grep -i "critical\|warning")

    # Report anomalies
    if [ -z "$OPAL_STATUS" ]; then
        echo "ALERT: $DEVICE - Opal locking not enabled"
        logger -t sed-monitor "Opal security disabled on $DEVICE"
    fi

    if [ -n "$SMART_LOG" ]; then
        echo "WARNING: $DEVICE - SMART anomalies detected"
        logger -t sed-monitor "SMART warnings on $DEVICE: $SMART_LOG"
    fi
done
                    </pre>
                </div>
            </div>
        </section>

        <!-- Multi-Tenant & Cloud Security -->
        <section class="demo-section">
            <h2 class="section-title">â˜ï¸ Multi-Tenant & Cloud SED Security</h2>

            <div class="security-component">
                <h3>ğŸ¢ Enterprise Multi-Tenancy</h3>

                <div class="encryption-layer">
                    <h4>Tenant Isolation Strategies</h4>
                    <ul>
                        <li><strong>Per-Tenant Keys:</strong> Separate encryption keys per customer</li>
                        <li><strong>Range-Based Isolation:</strong> Hardware-enforced storage boundaries</li>
                        <li><strong>Namespace Isolation:</strong> NVMe namespace per tenant</li>
                        <li><strong>Secure Multi-tenancy:</strong> Hardware guarantees for data separation</li>
                    </ul>

                    <h4>Cloud Provider SED Architecture</h4>
                    <pre class="code-block">
# Multi-Tenant SED Configuration Example

# Tenant A (High Security Financial Services)
Namespace: nvme0n1p1 (0-500GB)
Locking Range: 0 (LBA 0 - 1,048,576,000)
Authentication: Certificate + Smart Card
Key Rotation: Daily
Compliance: FIPS 140-2 Level 3

# Tenant B (Standard Web Application)
Namespace: nvme0n1p2 (500GB-1TB)
Locking Range: 1 (LBA 1,048,576,001 - 2,097,152,000)
Authentication: Password + TOTP
Key Rotation: Monthly
Compliance: SOC 2 Type II

# Tenant C (Development Environment)
Namespace: nvme0n1p3 (1TB-1.5TB)
Locking Range: 2 (LBA 2,097,152,001 - 3,145,728,000)
Authentication: Password
Key Rotation: Quarterly
Compliance: Basic data protection

# Configuration Commands:
sedutil-cli --setupLockingRange 0 0 1048576000 &lt;TenantA_Key&gt; /dev/nvme0n1
sedutil-cli --setupLockingRange 1 1048576001 2097152000 &lt;TenantB_Key&gt; /dev/nvme0n1
sedutil-cli --setupLockingRange 2 2097152001 3145728000 &lt;TenantC_Key&gt; /dev/nvme0n1
                    </pre>
                </div>

                <h3>ğŸ”„ Operational Security Procedures</h3>
                <div class="security-demo">
                    <h4>Secure Decommissioning Workflow</h4>
                    <pre class="code-block">
#!/bin/bash
# Secure SED Decommissioning Procedure

DEVICE="/dev/nvme0n1"
TENANT_ID="$1"

echo "Starting secure decommissioning for tenant: $TENANT_ID"

# Step 1: Backup verification (if required)
echo "1. Verifying backup completion..."
./verify_backup.sh "$TENANT_ID" || exit 1

# Step 2: Cryptographic erase for tenant's range
echo "2. Performing cryptographic erase..."
sedutil-cli --revert "$DEVICE" --password "$TENANT_PASSWORD"

# Step 3: Verify erase completion
echo "3. Verifying erase completion..."
if sedutil-cli --query "$DEVICE" | grep -q "No Locking"; then
    echo "SUCCESS: Cryptographic erase completed"

    # Log the decommissioning event
    logger -t sed-decom "Tenant $TENANT_ID successfully decommissioned from $DEVICE"

    # Update inventory management
    curl -X POST "https://inventory.company.com/api/decommission" \
         -H "Content-Type: application/json" \
         -d "{\"device\":\"$DEVICE\", \"tenant\":\"$TENANT_ID\", \"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
else
    echo "ERROR: Decommissioning failed"
    exit 1
fi

# Step 4: Physical security (if drive leaving facility)
echo "4. Drive ready for physical destruction or redeployment"
                    </pre>

                    <h4>Compliance & Audit Requirements</h4>
                    <ul>
                        <li><strong>Access Logging:</strong> All SED operations logged with timestamps</li>
                        <li><strong>Key Lifecycle:</strong> Complete audit trail for key operations</li>
                        <li><strong>Compliance Reports:</strong> Automated FIPS/Common Criteria reporting</li>
                        <li><strong>Incident Response:</strong> Documented procedures for SED compromise</li>
                        <li><strong>Regular Audits:</strong> Third-party security assessments</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Interactive Security Demo -->
        <section class="demo-section">
            <h2 class="section-title">ğŸ® Interactive NVMe Security Demo</h2>

            <div class="demo-controls">
                <button onclick="demonstrateTCGOpal()" class="demo-button">
                    ğŸ” TCG Opal Configuration
                </button>
                <button onclick="simulateSecurityAttack()" class="demo-button">
                    âš ï¸ Attack Simulation
                </button>
                <button onclick="showKeyManagement()" class="demo-button">
                    ğŸ”‘ Key Management
                </button>
                <button onclick="auditSecurityCompliance()" class="demo-button">
                    ğŸ“‹ Security Audit
                </button>
            </div>

            <div id="nvme-security-demo-output" class="demo-output">
                <p>Click any button above to explore NVMe security features and threat mitigation strategies.</p>
            </div>
        </section>
    </main>

    <footer class="demo-footer">
        <div class="footer-nav">
            <a href="datacenter-gpu-resources.html">â† GPU Resources</a>
            <a href="gpu-security-deep-dive.html">GPU Security â†’</a>
        </div>
        <p>&copy; 2024 DataCenter Hardware Security Course. Educational content for masters-level study.</p>
    </footer>

    <script src="nvme-security-demo.js"></script>
</body>
</html>